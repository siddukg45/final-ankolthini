<!DOCTYPE html>
<html>
<head>
  <title>Dashboard - {{ emp_name }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      background: linear-gradient(120deg,#071029,#071b2e);
      color:#e6eef8;
      font-family: 'Segoe UI', Roboto, sans-serif;
      padding: 28px;
      overflow-x: hidden;
    }
    .card {
      border-radius: 14px;
      color: #e6eef8;
      background: rgba(255,255,255,0.03);
      box-shadow: 0 12px 30px rgba(2,6,23,0.7);
      padding:18px;
      position: relative;
    }
    .header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin-bottom:18px;
    }
    .sub { color:#98a9bf; font-size:14px; }
    .chip {
      padding:6px 10px;
      border-radius:999px;
      font-weight:600;
      font-size:13px;
      display:inline-block;
    }
    .present { background: rgba(34,197,94,0.12); color:#8ef08e; }
    .absent  { background: rgba(239,68,68,0.08); color:#ff9a9a; }
    .half    { background: rgba(255,215,0,0.12); color:#ffd700; }
    .legend-box {
      position: absolute;
      top: 10px;
      right: 12px;
      font-size: 11px;
      display: flex;
      gap: 12px;
      opacity: 0.8;
    }
    .legend-item { display:flex; align-items:center; gap:5px; }
    .legend-dot {
      width:8px; height:8px;
      border-radius:50%;
      display:inline-block;
    }
    .btn-glow {
      background:#2563eb;
      color:white;
      border:none;
      padding:6px 14px;
      border-radius:8px;
      font-weight:600;
    }
    .btn-glow:hover {
      background:#1d4ed8;
      color:white;
    }
  </style>
</head>

<body>

<div class="header d-flex justify-content-between align-items-center">
  <div>
    <div class="welcome">Hello, {{ emp_name }} <small class="sub">({{ emp_id }})</small></div>
    <div class="sub">Employee Dashboard • Attendance Overview</div>
  </div>

  <div class="d-flex align-items-center gap-4">
    <div class="stat text-start">  
      <div style="font-size:12px;color:#98a9bf">Summary</div>
      <div style="font-weight:800;font-size:18px" id="presentSummary">Present: 0</div>
      <div style="font-size:12px;color:#98a9bf" id="halfSummary">Half-day: 0</div>
    </div>

    <a href="{{ url_for('logout') }}" class="logout-btn">Logout</a>
  </div>
</div>

<div class="row g-3 mb-3">

  <div class="col-md-6">
    <div class="card" style="height:360px;">
      <strong>Attendance Chart</strong>
      <div class="sub">View by Week, Month or Year</div>

      <div class="legend-box">
        <div class="legend-item"><span class="legend-dot" style="background:#3b82f6"></span> Present</div>
        <div class="legend-item"><span class="legend-dot" style="background:#facc15"></span> Half-day</div>
        <div class="legend-item"><span class="legend-dot" style="background:#ef4444"></span> Absent</div>
      </div>

      <div class="d-flex gap-2 mt-3">
        <select id="modeSelect" class="form-select form-select-sm bg-dark text-light" style="max-width:130px;">
          <option value="week" selected>Week</option>
          <option value="month">Month</option>
          <option value="year">Year</option>
        </select>

        <select id="yearSelect" class="form-select form-select-sm bg-dark text-light" style="max-width:110px;"></select>

        <select id="monthSelect" class="form-select form-select-sm bg-dark text-light" style="max-width:130px;"></select>
      </div>

      <div class="chart-container mt-3">
        <canvas id="weekChart"></canvas>
      </div>
    </div>
  </div>
  <!-- EXPORT CARD -->
  <div class="col-md-6">
    <div class="card" style="height:360px;">
      <strong>Export & Quick View</strong>
      <div class="sub">Select date or date-range</div>

      <div class="row g-2 mt-2">
        <div class="col-6">
          <label class="sub">From</label>
          <input id="start" type="date" class="form-control">
        </div>
        <div class="col-6">
          <label class="sub">To</label>
          <input id="end" type="date" class="form-control">
        </div>

        <div class="col-12 mt-3 d-flex gap-2">
          <button id="btnFetch" class="btn-glow">Fetch</button>
          <button id="btnDownload" class="btn btn-outline-light">Download Excel</button>
        </div>
      </div>
    </div>
  </div>

</div> <!-- row end -->

<!-- TABLE -->
<div class="card">
  <strong>Attendance Details</strong>
  <div class="sub">List of dates in the selected view</div>

  <div class="table-responsive mt-2">
    <table class="table table-dark table-borderless">
      <thead class="text-muted small">
        <tr>
          <th>Date</th>
          <th>IN1</th>
          <th>OUT1</th>
          <th>IN2</th>
          <th>OUT2</th>
          <th>Hours</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="attRows"></tbody>
    </table>
  </div>
</div>
<!-- JS START -->
<script>

const today = "{{ current_date }}";

const startInput = document.getElementById("start");
const endInput   = document.getElementById("end");

const attRows = document.getElementById("attRows");

const yearSelect  = document.getElementById("yearSelect");
const monthSelect = document.getElementById("monthSelect");
const modeSelect  = document.getElementById("modeSelect");

const presentSummaryEl = document.getElementById("presentSummary");
const halfSummaryEl    = document.getElementById("halfSummary");

/* ============================= UTILITIES ============================= */

function formatISO(d){
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}

/* Default last 7 days */
endInput.value = today;
const d0 = new Date(today);
d0.setDate(d0.getDate()-6);
startInput.value = formatISO(d0);

/* ============================ DROPDOWNS ============================== */

(function(){
  const cy = new Date(today).getFullYear();
  for(let y=cy; y>=cy-5; y--){
    yearSelect.innerHTML += `<option value="${y}">${y}</option>`;
  }
  yearSelect.value = cy;
})();

(function(){
  const months = [
    "January","February","March","April","May","June",
    "July","August","September","October","November","December"
  ];
  months.forEach((m,i)=> monthSelect.innerHTML += `<option value="${i+1}">${m}</option>`);
  monthSelect.value = new Date(today).getMonth()+1;
})();

/* ============================ API CALL =============================== */

async function fetchRange(start, end){
  const res = await fetch(`/api/attendance_range?start=${start}&end=${end}`, {
    credentials: "include"
  });
  const data = await res.json();
  return data.rows || [];
}

/* ============================ TABLE RENDER =========================== */

function renderTable(rows){
  attRows.innerHTML = "";

  if (!rows.length){
    attRows.innerHTML =
      `<tr><td colspan="7" class="text-center text-muted">No records</td></tr>`;
    presentSummaryEl.textContent = "Present: 0";
    halfSummaryEl.textContent    = "Half-day: 0";
    return;
  }

  let present = 0;
  let half = 0;

  rows.forEach(r=>{
    let status = "absent";
    if ((r.in1||r.out1) && (r.in2||r.out2)) { status="present"; present++; }
    else if (r.in1||r.out1||r.in2||r.out2) { status="half"; half++; }

    let cls = status==="present" ? "present" :
              status==="half"    ? "half" :
                                   "absent";

    attRows.innerHTML += `
      <tr>
        <td>${r.date}</td>
        <td>${r.in1 || "-"}</td>
        <td>${r.out1 || "-"}</td>
        <td>${r.in2 || "-"}</td>
        <td>${r.out2 || "-"}</td>
        <td>${r.present_hours || 0}h</td>
        <td><span class="chip ${cls}">${cls==="present"?"Present":cls==="half"?"Half-day":"Absent"}</span></td>
      </tr>
    `;
  });

  presentSummaryEl.textContent = `Present: ${present}`;
  halfSummaryEl.textContent    = `Half-day: ${half}`;
}
/* ============================ CHART ============================= */

let chart = null;
function destroyChart(){
  if(chart){ chart.destroy(); chart=null; }
}

/* ===================== THIN LINE PLUGIN ====================== */
const statusLinePlugin = {
  id:"statusLinePlugin",
  afterDatasetsDraw(chart,args){
    const mode = modeSelect.value;
    const meta = chart.getDatasetMeta(0);
    const {ctx} = chart;
    const statuses = chart.data.datasets[0].statusFlags;
    const future = chart.data.datasets[0].futureFlags;

    meta.data.forEach((bar,i)=>{

      if(future[i]) return;  // skip future days

      const s = statuses[i];

      // WEEK → only absent line
      if(mode==="week"){
        if(s!=="absent") return;
      }
      // MONTH + YEAR → half (yellow) + absent (red)
      else {
        if(s!=="half" && s!=="absent") return;
      }

      ctx.save();
      ctx.strokeStyle = s==="half" ? "#facc15" : "#ef4444";
      ctx.lineWidth = 2;

      ctx.beginPath();
      ctx.moveTo(bar.x - bar.width/2, bar.y + 4);
      ctx.lineTo(bar.x + bar.width/2, bar.y + 4);
      ctx.stroke();

      ctx.restore();
    });
  }
};


/* ======================= CUSTOM RANGE GRAPH ======================= */

async function renderCustomRange(start, end){

  destroyChart();

  const rows = await fetchRange(start, end);

  rows.sort((a,b)=> new Date(a.date) - new Date(b.date));

  const labels=[], values=[], statusArr=[], futureArr=[];

  const todayDate = new Date(today);
  const d1 = new Date(start);
  const d2 = new Date(end);

  const map = {};
  rows.forEach(r => map[r.date] = r);

  for(let d=new Date(d1); d<=d2; d.setDate(d.getDate()+1)){

    let key = formatISO(d);
    let r   = map[key];

    let status="absent", hours=0;
    const isFuture = d > todayDate;

    if(isFuture){
      labels.push(key);
      values.push(0);
      statusArr.push("future");
      futureArr.push(true);
      continue;
    }

    if(r){
      const am = (r.in1||r.out1);
      const pm = (r.in2||r.out2);

      if(am && pm){ status="present"; hours=r.present_hours; }
      else if(am || pm){ status="half"; hours=r.present_hours; }
    }

    labels.push(key);
    values.push(hours||0);
    statusArr.push(status);
    futureArr.push(false);
  }

  const barColors = statusArr.map(s =>
    s==="present" ? "#3b82f6" :
    s==="half"    ? "#facc15" :
                    "rgba(0,0,0,0)"   // absent invisible
  );

  const ctx=document.getElementById("weekChart").getContext("2d");

  chart=new Chart(ctx,{
    type:"bar",
    data:{
      labels:labels,
      datasets:[{
        data:values,
        backgroundColor:barColors,
        borderRadius:4,
        statusFlags:statusArr,
        futureFlags:futureArr
      }]
    },
    options:{
      maintainAspectRatio:false,
      plugins:{ legend:{display:false} },
      scales:{
        y:{ beginAtZero:true, max:9, ticks:{ stepSize:1, callback:v=>v+"h" } }
      }
    },
    plugins:[statusLinePlugin]
  });

  renderTable(rows);
}


/* ========================= DROPDOWN CONTROLLER ========================= */

async function loadChart(){

  const mode = modeSelect.value;
  const year = Number(yearSelect.value);
  const month= Number(monthSelect.value);

  if(mode==="week"){
    let e=today;
    let s=new Date(today);
    s.setDate(s.getDate()-6);
    return renderCustomRange(formatISO(s), e);
  }

  if(mode==="month"){
    const start=`${year}-${String(month).padStart(2,'0')}-01`;
    const days=new Date(year,month,0).getDate();
    const end=`${year}-${String(month).padStart(2,'0')}-${days}`;
    return renderCustomRange(start, end);
  }

  if(mode==="year") {

    destroyChart();

    const start = `${year}-01-01`;
    const end   = `${year}-12-31`;

    const rows = await fetchRange(start, end);

    const presentCount = new Array(12).fill(0);
    const halfCount    = new Array(12).fill(0);
    const statusArr    = new Array(12).fill("absent");

    rows.forEach(r=>{
        let d = new Date(r.date);
        let m = d.getMonth();

        const morning   = (r.in1 || r.out1);
        const afternoon = (r.in2 || r.out2);

        if (morning && afternoon){
            presentCount[m] += 1;
            statusArr[m] = "present";
        }
        else if (morning || afternoon){
            halfCount[m] += 1;
            if (statusArr[m] !== "present")
                statusArr[m] = "half";
        }
    });

    const labels = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

    const barColors = statusArr.map(s=>{
        if (s==="present") return "#3b82f6";
        if (s==="half")    return "#facc15";
        return "rgba(0,0,0,0)";
    });

    const ctx = document.getElementById("weekChart").getContext("2d");

    chart = new Chart(ctx,{
        type:"bar",
        data:{
            labels: labels,
            datasets:[{
                data: presentCount,
                backgroundColor: barColors,
                borderRadius: 6,
                statusFlags: statusArr
            }]
        },
        options:{
            maintainAspectRatio:false,
            plugins:{ legend:{display:false} },
            scales:{
                y:{
                    beginAtZero:true,
                    max: 30,
                    ticks:{ stepSize:5, callback:v=>v+" days" }
                }
            }
        }
    });

    updateTableForRange(start, end);
}

}
/* =============================== EVENTS =============================== */

modeSelect.onchange = loadChart;
yearSelect.onchange = loadChart;
monthSelect.onchange = loadChart;

document.getElementById("btnFetch").onclick = () =>{
  renderCustomRange(startInput.value, endInput.value);
};

document.getElementById("btnDownload").onclick = () =>{
  window.location = 
    `/download_attendance?start=${startInput.value}&end=${endInput.value}`;
};

/* ============================ INITIAL LOAD ============================ */
loadChart();

</script>

</body>
</html>
